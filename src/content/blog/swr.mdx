---
title: react SWR æ•°æ®è¯·æ±‚åº“æµ…æ
pubDate: 2023-11-22
intro: é€šè¿‡äº†è§£reactçš„æ•°æ®è¯·æ±‚éšè—çš„é—®é¢˜, æ¥å­¦ä¹ æ•°æ®è¯·æ±‚åº“SWRçš„åŠŸèƒ½ä»·å€¼
tag: react
author: lbsong
image: ../../assets/swr/icon.png
readTime: '10'
---

äº†è§£SWRçš„åŠŸèƒ½å’Œä½œç”¨å‰, å…ˆè®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¼ ç»Ÿçš„reactç»„ä»¶ä¸­æ ‡å‡†çš„ä¸€å¥—æ•°æ®è¯·æ±‚æµç¨‹

## æ ‡å‡†çš„reactæ•°æ®è¯·æ±‚

```javascript
  /* æ ‡å‡†çš„reactæ•°æ®è¯·æ±‚ */
  const fetchData = url => {
    return fetch(url).then(res => res.json())
  };
  const Parent = () => {
    const [data, setData] = useState({
      /* ä¸€ä¸ªè¯·æ±‚ä¼šæœ‰å¦‚ä¸‹çš„å‡ ä¸ªåŸºæœ¬çŠ¶æ€ ä¾›å‰ç«¯ç»„ä»¶ä½¿ç”¨ */
      data: {}, // æ¥å£è¯·æ±‚æˆåŠŸå è¿”å›æ•°æ®çš„æ•°æ®æ ¼å¼
      loading: false, // æ˜¯å¦æ­£åœ¨è¯·æ±‚
      error: {}, // errorä¿¡æ¯
      // æ›´å¤š
    });
    /* åœ¨çˆ¶ç»„ä»¶è¯·æ±‚æ•°æ®åæ‹¿åˆ°dataå, é€šè¿‡props drillingæˆ–è€…contextç­‰æ–¹å¼ä¼ é€’ç»™ å­ç»„ä»¶ä½¿ç”¨ */
    useEffect(() => {
      fetchData('/api/demo').then(d => setData(d));
    }, []);
    return (
      <>
        <ChildA />
        <ChildB />
      </>
    )
  }
```

åœ¨çœŸå®çš„å¼€å‘åœºæ™¯ä¸­, ä»¥ä¸Šè¿™ç§æ¨¡å¼ä¸»è¦ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜
1. éœ€è¦é€šç”¨çš„æ¥å£æ•°æ®å¤„ç†æ–¹æ³•å¤„ç†æ•°æ®è¯·æ±‚çš„è¿”å›æ•°æ®ç»“æ„(data, loading, errorç­‰çŠ¶æ€)

2. æ¥å£å¤ç”¨æ€§å·®, é¢å¤–å¤„ç†[çŠ¶æ€æå‡](https://react.dev/learn/sharing-state-between-components#lifting-state-up-by-example).
å½“æœ‰ä¸åŒçš„ç»„ä»¶åœ¨åŒä¸€é¡µé¢ç”¨åˆ°åŒä¸€æ¥å£æ—¶, ä¸ºäº†ä¸ä½¿ç›¸åŒæ¥å£è°ƒç”¨å¤šæ¬¡, é€šå¸¸ä¼šä½¿ç”¨çŠ¶æ€æå‡å°†æ¥å£çŠ¶æ€æå‡è‡³å…¬å…±çˆ¶ç»„ä»¶å¤„ç†, é€šè¿‡props drillingæˆ–è€…contextç­‰æ–¹å¼ä¼ é€’ç»™
æŒ‰éœ€ä½¿ç”¨, å½“å­ç»„ä»¶æ•°é‡è¾ƒå¤š åŒæ—¶å±‚çº§åµŒå¥—çš„æ¯”è¾ƒæ·±æ—¶, è¯¥æ–¹æ¡ˆä¼šç‰¹åˆ«éº»çƒ¦, bugç‡ä¼šæå‡, å¼€å‘ä½“éªŒä¹Ÿä¸å¥½

## SWRåŸºç¡€ä½¿ç”¨
ä¸‹é¢æ¥çœ‹ä¸€ä¸‹åœ¨å¦‚ä¸Šçš„ç›¸åŒåœºæ™¯ä¸­ä½¿ç”¨SWRçš„å†™æ³•

```javascript
  import useSWR from 'swr';
  const fetchData = url => {
    return fetch(url).then(res => res.json())
  };
  const Parent => () => {
    return (
      <>
        <ChildA />
        <ChildB />
      </>
    )
  }
  const ChildA = () => {
    const { data, loading, error } = useSWR(`/api/demo`, fetchData);
  }
  const ChildB = () => {
    const { data, loading, error } = useSWR(`/api/demo`, fetchData);
  }
```

é€šè¿‡é‡‡ç”¨SWRçš„å†™æ³•æ¨¡å¼, ä»£ç æ›´åŠ å…·æœ‰å£°æ˜æ€§, æˆ‘ä»¬åªè¦æŒ‡å®šä»€ä¹ˆç»„ä»¶è°ƒç”¨ä»€ä¹ˆæ¥å£è·å–æ•°æ®å³å¯, åŒæ—¶SWRå†…ç½®çš„ [ç¼“å­˜](https://swr.vercel.app/zh-CN/docs/advanced/cache) åŠŸèƒ½
å®Œç¾çš„è§£å†³äº†è¯·æ±‚å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜, å¦‚æœä½ æ¸²æŸ“äº†Parentç»„ä»¶, æŸ¥çœ‹Networkä½ ä¼šå‘ç°è¯·æ±‚åªè°ƒç”¨äº†ä¸€æ¬¡, perfect!, no more lift state up!ğŸ˜

## ç«æ€é—®é¢˜
```javascript
  export default function DataDisplayer(props) {
    const [data, setData] = useState(null);
    const [fetchedId, setFetchedId] = useState(null);

    useEffect(() => {
      const fetchData = async () => {
        setTimeout(async () => {
          const response = await fetch(
            `https://swapi.dev/api/people/${props.id}/`
          );
          const newData = await response.json();

          setFetchedId(props.id);
          setData(newData);
          // è®¾ç½®éšæœºå®šæ—¶å™¨ è¯·æ±‚ä¹±åºè¿”å›
        }, Math.round(Math.random() * 12000));
      };

      fetchData();
    }, [props.id]);

    return <div>{data}</div>;
  }
```
æŸ¥çœ‹ä¾‹å­ [codesandbox](https://codesandbox.io/p/sandbox/beating-async-race-conditions-in-react-7759f?file=%2Fpackage.json),
è¿è¡Œç»“æœå‘ç°domå¹¶æ²¡æœ‰æ¸²æŸ“ é¢„æœŸçš„æœ€åè¿”å›çš„è¯·æ±‚ç»“æœ, è¿™å°±æ˜¯reactç»„ä»¶ä¸­å¸¸è§çš„è¯·æ±‚ç«æ€é—®é¢˜ [ç«æ€](https://en.wikipedia.org/wiki/Race_condition)

### è§£å†³ç«æ€é—®é¢˜
```javascript
  useEffect(() => {
    let active = true;

    const fetchData = async () => {
      setTimeout(async () => {
        const response = await fetch(`https://swapi.dev/api/people/${props.id}/`);
        const newData = await response.json();
        if (active) {
          setFetchedId(props.id);
          setData(newData);
        }
      }, Math.round(Math.random() * 12000));
    };

    fetchData();
    // ä¸‹ä¸€æ¬¡useEffectä¹‹å‰ æ¸…ç†
    return () => {
      active = false;
    };
  }, [props.id]);
```

é€šè¿‡å°†activeè®¾ä¸ºfalse, è¿‡æ—¶çš„è¯·æ±‚æ— æ³•æ›´æ–°æˆ‘ä»¬æœ€æ–°çš„çŠ¶æ€ (è¯¥æ–¹æ¡ˆæ— æ³•è§£å†³è¯·æ±‚çš„ç«æ€é—®é¢˜, ä½†å¯ä»¥ç¡®ä¿æœ€åä¸€ä¸ªè¯·æ±‚çš„ç»“æœè¢«ä½¿ç”¨, å¯ä»¥ä½¿ç”¨ [Abort signalç»ˆæ­¢fetch](https://developer.mozilla.org/en-US/docs/Web/API/AbortController/signal)

## SWRä»·å€¼
åŸºäºä»¥ä¸Šreactä¸­çš„æ•°æ®è¯·æ±‚é—®é¢˜, å¦‚æœæˆ‘ä»¬ä¸é€‰æ‹©ä¸€ä¸ªæˆç†Ÿçš„æ•°æ®è¯·æ±‚åº“, é‚£ä¹ˆæˆ‘ä»¬å°†é¢å¯¹ä¸»è¦ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜
1. å¤ç”¨æ€§å·®, éœ€è¦é¢å¤–å¤„ç†æ¥å£çŠ¶æ€å’Œå°è£…è¯·æ±‚é€»è¾‘, åœ¨ç»„ä»¶æ•°é‡å¤šçš„æƒ…å†µä¸‹, ä¼ ç»Ÿçš„æ•°æ®è¯·æ±‚ä¼šç ´åä»£ç çš„å¯ç»´æŠ¤æ€§
2. ç«æ€é—®é¢˜

è€Œ [SWR](https://swr.vercel.app/) å†…ç½®çš„ç¼“å­˜æœºåˆ¶å’ŒåŠŸèƒ½å¸®æˆ‘ä»¬å®Œç¾è§£å†³ä»¥ä¸Šé—®é¢˜, è®©å¼€å‘äººå‘˜æ— éœ€åœ¨å…³å¿ƒè¿™äº›åŸºç¡€é—®é¢˜, åˆæ¬¡ä¹‹å¤–, SWRè¿˜æ‹¥æœ‰ä»¥ä¸‹çš„åŠŸèƒ½

1. æé€Ÿã€è½»é‡ã€å¯é‡ç”¨çš„ æ•°æ®è¯·æ±‚
2. å†…ç½® ç¼“å­˜ å’Œé‡å¤è¯·æ±‚å»é™¤
3. é—´éš”è½®è¯¢, åˆ†é¡µ, é‡æ–°éªŒè¯
4. Optimistic UI
5. [æ›´å¤š](https://swr.vercel.app/)

## å‚è€ƒæ–‡ç« 
1. https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect